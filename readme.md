## 这是什么

这是LINPX的后端，用于代理请求、清洗并整合数据、向上层提供服务。主要服务对象是LINPX前端和LINPX机器人。

此仓库为LINPX的后端的开源版，与LINPX线上实际版本有轻微差别（后面会详述），并且如果LINPX后端有继续开发，该开源版可能落后于线上版数个版本。

开源此项目仅为学习交流，如果意向开发类似linpx的项目可以进行参考而不必从头做起，严禁用于商业用途。

阅前提前：此项目不适合对node、express、服务器完全不了解的新手，最好有一定基础再深入了解此项目。



## 主要功能

1. 代理pixiv请求。

   由于国内无法直接访问pixiv后端api，单纯的前端无法请求到数据，所以需要自己编写后端代理请求。另外pixiv中的图片访问pximg时会进行referer检验，也无法纯粹通过前端解决。

2. 封装pixiv api，清洗整合数据，提供上层服务接口。

   由于pixiv的api较为分散，且不同端的数据格式较为混杂，难以满足实际业务需要，所以有必要在自建后端整合pixiv不同的接口和数据格式，向上层提供统一、清晰的数据。

3. 通过数据库提供部分缓存。

   将部分pixiv api请求到的数据缓存到数据库里，缓存过期前直接从数据库查询，从而提高响应数据，避免请求过于频繁。

4. 提供linpx定制的业务逻辑。

   linpx的推荐作者及其爱发电QQ群的CRUD、站内作者标签统计、站内阅赞评等linpx特有的功能。



## 项目结构

/request/pixiv：封装向pixiv发起数据请求。包括封装请求基本内容（UA、Cookie、referer、本地代理）、封装小说接口、封装用户接口、封装搜索接口、封装tag接口等部分。

/model：封装了mongodb的基本CRUD操作和linpx业务相关的类型和接口。

/data：将不同的pixiv接口整合为统一的、内聚的数据接口（比如：用户数据涉及到用户简介、用户介绍、用户标签三个pixiv api，现在封装后只需要调用这一个函数即可）。同时整合数据库缓存。

/api：定义linpx后端定义的api，这里定义的api就是最终其他linpx服务所访问的api了。

/schedule：定义linpx后端的每日任务，如刷新点击、点赞计数，刷新linpx标签统计等等。

/utils：一些通用的工具函数



## 不予公开的内容

linpx后端包含一些线上的敏感数据，比如：

- 数据库账号密码
- pixiv账号的phpsession
- 一些管理员接口

如果这些内容直接公开，任何阅读linpx后端的人将可以直接修改线上数据，甚至进行恶意攻击，所以这些内容将不予空开。



## 如何运行

1. 安装node、npm（或yarn）。

2. 克隆项目。

3. **配置/linpxconfig.ts中的一些数据项**。

   获取代理服务器地址。如果是本地代理则需要知道端口号。

   pixiv账号的session。

   搭建自己的mongodb数据库，然后填写数据库地址。

   ……

   在linpxconfig.ts文件中有详细描述。

4. 通过`npm install`或`yarn`命令安装依赖项。

5. 通过`npm start`运行项目。测试一些接口确保服务正常。

   其中如/analyse/tags需要从数据库获取数据，可以等待服务部署后的每日定时任务刷新tags记录，也可以仿照定时任务中的“更新tag缓存”部分手动调用函数更新数据库的tags记录。

6. 通过`npm build`构建项目，将在/dist目录下生成编译后的js文件。



## 鸣谢

node：感谢能用javascript写后端

node-schedule：node定时任务

express：很好用的node服务器框架

express-validator：用起来不那么顺手的express请求验证中间件

typescript：类型系统yyds，化屎为神奇

mongodb：可以快速上手的数据库

request：由于axios无法使用本地代理，所以只能用request了

uid：自动生成统一id

